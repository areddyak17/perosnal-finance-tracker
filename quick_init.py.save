"""
Run me **once** to create the users table and an admin account.

    python quick_init.py
"""

import sqlite3, getpass, bcrypt, os, sys

DB = "finance.db"
if not os.path.exists(DB):
    sys.exit("❌  finance.db not found – run app.py once to create it.")

con = sqlite3.connect(DB)
cur = con.cursor()

# 1. users table
cur.execute("""
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    pw_hash  BLOB NOT NULL
);
""")

# 2. link transactions to a user (if the column is missing)
cur.execute("PRAGMA table_info(transactions);")
cols = [c[1] for c in cur.fetchall()]
if "user_id" not in cols:
    cur.execute("ALTER TABLE transactions ADD COLUMN user_id INTEGER DEFAULT 1;")

# 3. add an admin user
username = input("Admin username: ").strip()
password = getpass.getpass("Password: ").encode()
pw_hash  = bcrypt.hashpw(password, bcrypt.gensalt())

cur.execute("INSERT OR IGNORE INTO users (username, pw_hash) VALUES (?,?)",
            (username, pw_hash))
con.commit()
print("✅  User created! You can now flask run.")
