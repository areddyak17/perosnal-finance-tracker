{% extends "layout.html" %}

{% block content %}
<section class="grid">
  <div class="card balance">
    <h2>Available Balance</h2>
    <p class="value">${{ '%.2f'|format(summary.balance) }}</p>
  </div>

  <div class="card networth">
    <h2>Total Net Worth</h2>
    <p class="value">${{ '%.2f'|format(net_worth) }}</p>
  </div>

  <div class="card small-chart">
    <h3>Spending by Category</h3>
    <canvas id="spendDonut"></canvas>
  </div>

  <div class="card small-chart">
    <h3>Income vs Expenses</h3>
    <canvas id="incomeExpensesBar"></canvas>
  </div>

  <div class="card insight">
    <h3>AI Insight</h3>
    <ul>{% for line in ai_insights %}<li>{{ line|safe }}</li>{% endfor %}</ul>
  </div>

  <div class="card transactions span-2">
    <h3>Recent Transactions</h3>
    <table>
      <thead><tr><th>Date</th><th>Description</th><th>Category</th><th class="right">Amount</th><th></th></tr></thead>
      <tbody>
        {% for t in recent %}
        <tr>
          <td>{{ t.date }}</td><td>{{ t.description }}</td><td>{{ t.category }}</td>
          <td class="right">{{ '%.2f'|format(t.amount) }}</td>
          <td><form action="{{ url_for('delete_transaction', id=t.id) }}" method="post"><button class="btn-delete">Delete</button></form></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card span-2">
    <h3>Monthly Income vs Expenses</h3>
    <canvas id="monthlyIncomeExpenses"></canvas>
  </div>

  <!-- Savings Goal + inline goal setter -->
  <div class="card span-2">
    <div class="goal-header">
      <h3>Savings Goal</h3>
      <form class="goal-form" method="post" action="{{ url_for('set_goal') }}">
        <label>Desired Goal $
          <input type="number" name="savings_goal" step="0.01" min="1" value="{{ '%.2f'|format(savings_goal) }}" required>
        </label>
        <button class="btn small" type="submit">Update</button>
      </form>
    </div>

    {% if savings_percent >= 100 %}
      <div class="celebrate">ðŸŽ‰ Goal reached! Amazing work. ðŸŽ‰</div>
    {% endif %}

    <div class="progress-bar"><div class="progress" style="width: {{ savings_percent }}%"></div></div>
    <p class="muted">${{ '%.2f'|format(summary.balance) }} / ${{ '%.2f'|format(savings_goal) }}</p>
  </div>
</section>

<script>
new Chart(document.getElementById('spendDonut'), {
  type: 'doughnut',
  data: { labels: {{ cat_labels|tojson }}, datasets: [{ data: {{ cat_values|tojson }} }] },
  options: { plugins: { legend: { position: 'bottom' } } }
});
new Chart(document.getElementById('incomeExpensesBar'), {
  type: 'bar',
  data: { labels: ['Income','Expenses'], datasets: [{ data: [{{ summary.income }}, {{ summary.expenses }}] }] },
  options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display:false } } }
});
new Chart(document.getElementById('monthlyIncomeExpenses'), {
  type: 'bar',
  data: { labels: {{ months|tojson }}, datasets: [
    { label:'Income', data: {{ monthly_income|tojson }} },
    { label:'Expenses', data: {{ monthly_expenses|tojson }} }
  ]},
  options: { responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } }
});
(function(){
  const pct = {{ savings_percent|tojson }};
  if (pct >= 100 && typeof confetti === 'function') {
    const end = Date.now() + 1500;
    (function frame(){
      confetti({ particleCount: 6, spread: 70, startVelocity: 45, scalar: .9, origin:{ y:.6 } });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
  }
})();
</script>
{% endblock %}




